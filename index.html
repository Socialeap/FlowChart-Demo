<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlowChart Manager - Demo & Tutorial</title>

  <link
    rel="icon"
    type="image/png"
    href="https://static.wixstatic.com/media/c3283f_a3e1ec47496f42f7be617a2cd7a7bc9e~mv2.png"
  />

  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"
  />

  <style>
    :root {
      --bg-primary: linear-gradient(135deg, #939ef5 0%, #9e76d6 100%);
      --header-fixed-bg: #20232a;
      --header-glass-border: rgba(255, 255, 255, 0.1);
      --text-on-header: white;
      --button-bg: rgba(255, 255, 255, 0.25);
      --button-text: var(--text-on-header);
      --button-hover-bg: rgba(255, 255, 255, 0.4);
      --backdrop-blur: 10px;
      --input-bg: rgba(255, 255, 255, 0.2);
      --input-border: rgba(200, 200, 220, 0.4);
      --input-text: #1c1c1e;
      --glass-border: rgba(200, 200, 220, 0.4);
      --modal-bg: rgba(255, 255, 255, 0.3);
      --modal-text: #1c1c1e;
      --close-button-color: rgba(0, 0, 0, 0.5);
      --close-button-hover-color: #000;
      --flowchart-container-bg: rgba(255, 255, 255, 0.15);
      --flowchart-container-border: rgba(200, 200, 220, 0.3);
      --node-text-fill: var(--text-on-glass-light-bg, #1c1c1e);
      --node-fill-opacity: 0.45;
      --task-count-rect-bg: rgba(44, 62, 80, 0.75);
      --task-count-text-fill: white;
      --task-count-border: rgba(255, 255, 255, 0.2);
      --modal-strong-shadow: 0 15px 45px rgba(0, 0, 0, 0.15);
      --link-color: #555;
      --link-selected-color: #e74c3c;
      --demo-badge-bg: #ff6b35;
      --demo-badge-text: white;
    }

    body.dark-mode {
      --bg-primary: linear-gradient(135deg, #101020 0%, #0c1428 50%, #08203f 100%);
      --text-on-header: #e0e0e0;
      --button-bg: rgba(255, 255, 255, 0.12);
      --button-text: #e0e0e0;
      --button-hover-bg: rgba(255, 255, 255, 0.22);
      --input-bg: rgba(255, 255, 255, 0.1);
      --input-border: rgba(255, 255, 255, 0.2);
      --input-text: #e0e0e0;
      --glass-border: rgba(255, 255, 255, 0.15);
      --modal-bg: rgba(25, 30, 45, 0.5);
      --modal-text: #e0e0e0;
      --flowchart-container-bg: rgba(10, 10, 20, 0.1);
      --flowchart-container-border: rgba(255, 255, 255, 0.1);
      --modal-strong-shadow: 0 15px 45px rgba(0, 0, 0, 0.4);
      --link-color: #aaa;
      --link-selected-color: #ff5252;
      --demo-badge-bg: #ff8a50;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: #333; display: flex; flex-direction: column; min-height: 100vh; transition: background 0.5s ease; position: relative; overflow-x: hidden; }
    body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-primary); z-index: -1; transition: background 0.5s ease; }
    header { background: var(--header-fixed-bg); backdrop-filter: blur(var(--backdrop-blur)); -webkit-backdrop-filter: blur(var(--backdrop-blur)); border-bottom: 1px solid var(--header-glass-border); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); color: var(--text-on-header); padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; position: sticky; top: 0; z-index: 999; }
    header h1 { display: flex; align-items: center; margin: 0; font-size: 1.75rem; font-weight: 600; color: var(--text-on-header); }
    #headerLogo { width: 32px; height: 32px; margin-right: 0.75rem; }
    .demo-badge { background: var(--demo-badge-bg); color: var(--demo-badge-text); padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-left: 1rem; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
    header h1 input#flowchartNameInput { margin-left: 1rem; font-size: 0.9rem; padding: 0.5rem 1rem; border: 1px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--input-text); transition: all 0.3s ease; font-weight: 400; }
    header h1 input#flowchartNameInput:focus { outline: none; border-color: var(--glass-border); box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1); }
    nav { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    nav button, #themeToggleBtn { background: var(--button-bg); backdrop-filter: blur(var(--backdrop-blur)); -webkit-backdrop-filter: blur(var(--backdrop-blur)); border: 1px solid var(--header-glass-border); color: var(--button-text); padding: 0.5rem; width: 2.5rem; height: 2.5rem; border-radius: 8px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
    nav button:hover, #themeToggleBtn:hover { background: var(--button-hover-bg); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); }
    nav button:active, #themeToggleBtn:active, nav button.active { transform: translateY(0); background: var(--button-hover-bg); box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3); }
    #fileNameDisplay { margin-left: 1rem; font-size: 0.9rem; color: var(--text-on-header); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }
    #tooltip { position: fixed; background-color: var(--header-fixed-bg); color: var(--text-on-header); padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; z-index: 10001; pointer-events: none; visibility: hidden; opacity: 0; white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.25); border: 1px solid var(--header-glass-border); transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; transform: translateX(-50%) translateY(10px); }
    #tooltip.visible { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
    #color-legend-display { position: sticky; top: 80px; width: calc(100% - 2rem); margin: 0 auto 1rem auto; padding: 0.5rem 1rem; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--header-glass-border); border-radius: 12px; z-index: 998; display: none; align-items: center; justify-content: center; gap: 1.5rem; flex-wrap: wrap; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; }
    #color-legend-display.visible { display: flex; }
    .legend-display-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-on-header); }
    .legend-display-color { width: 14px; height: 14px; border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.3); }
    #flowchartContainer { width: calc(100% - 2rem); flex-grow: 1; border: 1px solid var(--flowchart-container-border); background: var(--flowchart-container-bg); overflow: hidden; position: relative; margin: 1rem; border-radius: 20px; box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1); }
    #flowchart { display: block; width: 100%; height: 100%; }
    /* MODIFIED: Styles for link elements */
    line.link { cursor: pointer; transition: stroke 0.3s ease, stroke-width 0.3s ease; }
    line.link.selected { stroke: var(--link-selected-color) !important; stroke-width: 4px; stroke-dasharray: 5, 5; }
    #banner-container { position: absolute; top: 10px; left: 10px; width: 48%; max-width: 588px; aspect-ratio: 1500 / 625; border-radius: 12px; overflow: hidden; background: transparent; z-index: 50; }
    #banner-container iframe { width: 100%; height: 100%; border: none; background: transparent; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); padding-top: 50px; overflow-y: auto; }
    .modal-content { background: var(--modal-bg); border: 1px solid var(--glass-border); color: var(--modal-text); margin: 20px auto; padding: 2rem; width: 90%; max-width: 750px; overflow-y: auto; max-height: calc(100vh - 100px); border-radius: 20px; position: relative; box-shadow: var(--modal-strong-shadow); transition: background 0.3s ease, border-color 0.3s ease; }
    /* MODIFIED: Adjusted max-width for the new connector options modal */
    #connectorOptionsModal .modal-content, #colorLegendModal .modal-content, #demoSaveModal .modal-content { max-width: 500px; text-align: center; }
    #shareModal .modal-content { max-width: 1200px; }
    #shareModal iframe { width: 100%; height: 85vh; border: none; }
    #color-legend-entries { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; text-align: left; }
    .legend-entry { display: flex; align-items: center; gap: 1rem; }
    .legend-color-swatch { width: 32px; height: 32px; border-radius: 8px; border: 2px solid var(--glass-border); flex-shrink: 0; }
    .legend-entry input { flex-grow: 1; }
    .close-button { position: absolute; right: 15px; top: 15px; font-size: 24px; cursor: pointer; color: var(--close-button-color); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255, 255, 255, 0.1); transition: all 0.3s ease; z-index: 10; }
    .close-button:hover { color: var(--close-button-hover-color); background: rgba(255, 255, 255, 0.2); transform: scale(1.1); }
    form { display: flex; flex-direction: column; gap: 1rem; text-align: left; }
    input, select, textarea { padding: 12px 16px; border: 1px solid var(--input-border); border-radius: 12px; font-size: 1em; background: var(--input-bg); color: var(--input-text); font-family: 'Inter', 'Segoe UI', sans-serif; transition: all 0.3s ease; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--glass-border); box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1); transform: translateY(-1px); }
    textarea { resize: vertical; min-height: 80px; }
    #taskName { width: 100%; }
    .modal-btn { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--modal-text); padding: 10px 20px; border-radius: 10px; font-size: 1em; font-weight: 500; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; }
    .modal-btn:hover { background: rgba(255, 255, 255, 0.25); border-color: rgba(255, 255, 255, 0.3); transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1); }
    .modal-btn:active { transform: translateY(0); box-shadow: none; }
    .modal-btn.danger { background-color: rgba(231, 76, 60, 0.5); }
    .modal-btn.danger:hover { background-color: rgba(231, 76, 60, 0.7); }
    .modal-btn.primary { background-color: rgba(52, 152, 219, 0.7); color: white; }
    .modal-btn.primary:hover { background-color: rgba(52, 152, 219, 0.9); }
    .flowchart-node-html-wrapper { overflow: visible; }
    .flowchart-node-html { background-color: transparent; border: 1px solid var(--glass-border); box-shadow: var(--modal-strong-shadow); border-radius: 18px; width: 100%; height: 100%; display: flex; flex-direction: column; padding: 8px; box-sizing: border-box; color: var(--node-text-fill); text-align: center; cursor: move; overflow: hidden; transition: background-color 0.3s ease, border-color 0.3s ease; }
    .flowchart-node-html.dragging { transition: none !important; }
    .node-name-html { font-weight: 500; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); word-break: break-word; flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 0 5px; }
    .task-count-pill-html { background: var(--task-count-rect-bg); color: var(--task-count-text-fill); padding: 4px 10px; border-radius: 14px; font-weight: 600; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); border: 1px solid var(--task-count-border); white-space: nowrap; margin-bottom: auto; }
    .priority-indicator { font-size: 0.8em; line-height: 1; margin-top: auto; align-self: flex-end; padding: 4px; }
    #userGuideModal .modal-content ul {list-style: none; padding: 0; text-align: left;}
    #userGuideModal .modal-content a { color: var(--modal-text); text-decoration: underline; }
    .modal-content h2, #userGuideModal .modal-content h2 { font-size: 1.5em; margin-bottom: 1em; }
    .modal-content h3, #userGuideModal .modal-content h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-size: 1.15em; color: var(--modal-text); text-align: left;}
    .modal-content li, #userGuideModal .modal-content li { margin-bottom: 0.7em; line-height: 1.6; }
    #userGuideModal .modal-content li strong { font-weight: 600; color: var(--modal-text); }
    .modal-content p, #userGuideModal .modal-content p { margin-bottom: 1em; line-height: 1.6; }

    /* Styling for the task text and new view icon */
    #taskTextPopup #taskFullText a {
        color: var(--link-color);
        text-decoration: underline;
    }
    #taskTextPopup #taskFullText a:hover {
        text-decoration: none;
    }
    .instruction-text {
        font-size: 0.85em;
        color: var(--modal-text);
        opacity: 0.7;
        margin-left: 0.5em;
        font-weight: normal;
    }
    
    /* MODIFIED: Styles for the task row in the table */
    #taskTable tbody tr td.task-cell-content { /* Target the specific td for flex */
        display: flex; /* Make the td a flex container */
        align-items: flex-end; /* Align items to the bottom, useful for multiline textareas */
        gap: 8px; /* Space between textarea and icon */
        /* Removed position: relative; here as it's not strictly necessary for flex positioning */
    }

    #taskTable tbody tr .task-detail-textarea {
        flex-grow: 1; /* Textarea takes up most of the space */
        min-height: 38px; /* Ensure a consistent base height */
        overflow: hidden; /* Hide scrollbar */
        resize: none; /* Prevent manual resizing by user to ensure auto-height works */
        border-radius: 12px; /* Ensure all corners are rounded */
        box-sizing: border-box; /* Include padding/border in element's total width and height */
        padding-right: 12px; /* Ensure sufficient internal padding */
    }

    .task-view-icon {
        flex-shrink: 0; /* Prevent icon from shrinking */
        font-size: 1.1em;
        color: var(--close-button-color); /* Use a subtle color */
        cursor: pointer;
        transition: color 0.2s ease, transform 0.2s ease;
        padding: 5px; /* Make it easier to click */
        border-radius: 50%; /* Make it look like a button */
        margin-bottom: 3px; /* slight adjustment to align with textarea base */
    }
    .task-view-icon:hover {
        color: var(--close-button-hover-color);
        transform: scale(1.1); /* No translateY needed if not absolutely positioned */
        background: rgba(255, 255, 255, 0.1);
    }
    /* Adjust task table header for the new icon column if desired, or let it implicitly align */
    #taskTable thead th:last-child {
        /* If you wanted a header for the icon, you'd add another <th> */
        /* For now, just ensure 'Task' column has enough width */
    }

    /* NEW CSS for color panel visibility and layout */
    .color-panel {
        display: flex; /* Makes it a flex container */
        flex-wrap: wrap; /* Allows swatches to wrap to the next line if needed */
        gap: 10px; /* Adds space between color swatches */
        justify-content: center; /* Centers the swatches horizontally */
        margin-top: 5px; /* Add a little space above the panel */
    }
    .color-swatch {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: 2px solid var(--glass-border);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        flex-shrink: 0; /* Prevent swatches from shrinking */
    }
    .color-swatch.selected-swatch {
        transform: scale(1.1);
        box-shadow: 0 0 0 3px var(--modal-text); /* Highlight selected swatch */
    }
    .color-swatch:hover {
        transform: scale(1.05);
        box-shadow: 0 0 0 2px var(--modal-text);
    }

    /* NEW: Styles for Connector Options Modal */
    #connectorOptionsModal .modal-content h2 {
        text-align: center;
    }
    #connectorOptionsModal label {
        display: block;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--modal-text);
    }
    /* MODIFIED: Layout for the arrow controls */
    .arrow-controls-group { /* New container for Add and Switch buttons */
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }
    .style-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 1rem;
    }
    .line-style-btn, .arrow-control-btn { /* Combined class for new arrow buttons */
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--modal-text);
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 0.95em;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        flex: 1; /* Allows buttons to grow and fill available space evenly */
        min-width: 90px; /* Ensure consistent minimum button size */
    }
    .line-style-btn i, .arrow-control-btn i { /* Combined icon styling */
        font-size: 1.1em;
    }
    /* Styles for selected/active state */
    .line-style-btn.selected, .arrow-control-btn.selected {
        background: var(--button-hover-bg); 
        border-color: var(--link-selected-color); 
        box-shadow: 0 0 0 2px var(--link-selected-color);
        color: var(--text-on-header); 
    }
    /* Hover effects for non-selected buttons */
    .line-style-btn:hover:not(.selected), .arrow-control-btn:hover:not(.selected) {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-1px);
    }
    /* Styling for disabled buttons */
    .arrow-control-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none; /* Prevent clicks */
        transform: translateY(0) !important; /* Override hover transform */
        box-shadow: none !important; /* Override hover shadow */
    }

    .link-options-action-buttons {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    .link-options-action-buttons .modal-btn {
        flex: 1; 
    }

    /* Styles for D3.js SVG Arrows */
    .link-arrow {
        pointer-events: none; /* Do not block clicks on the line */
        fill: var(--link-color); /* Arrow color defaults to link color */
        transition: fill 0.3s ease;
    }
    .link.selected + .link-arrow { /* If link is selected, change arrow color */
        fill: var(--link-selected-color) !important;
    }
    /* NEW: Styles for the wider transparent hit area line */
    line.link-hit-area {
        stroke: transparent;
        stroke-width: 15px; /* Make this much wider than the visible line */
        cursor: pointer; /* Ensure it still shows pointer cursor */
        pointer-events: stroke; /* Only respond to clicks on the stroke itself */
    }
    /* Ensure the visible line doesn't capture clicks */
    line.link-visible {
        pointer-events: none; /* Let clicks pass through to the hit area */
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/linkifyjs@4/dist/linkify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/linkify-html@4/dist/linkify-html.min.js"></script>
</head>

<body>
  <header>
    <h1>
      <img src="https://static.wixstatic.com/media/c3283f_a3e1ec47496f42f7be617a2cd7a7bc9e~mv2.png" alt="Logo" id="headerLogo"/> 
      FlowChart Manager
      <span class="demo-badge">Demo & Tutorial</span>
      <input type="text" id="flowchartNameInput" placeholder="Enter Flowchart Name…" readonly/>
    </h1>
    <nav>
      <button id="nodeSizeIncreaseBtn" data-tooltip-text="Increase Node Size"><i class="fas fa-plus"></i></button>
      <button id="nodeSizeDecreaseBtn" data-tooltip-text="Decrease Node Size"><i class="fas fa-minus"></i></button>
      <button id="aiAssistantBtn" data-tooltip-text="AI Assistant (turn off 'Full Screen')"><i class="fas fa-lightbulb"></i></button>
      <button id="userGuideBtn" data-tooltip-text="User Guide"><i class="fas fa-book-open"></i></button>
      <button id="colorLegendBtn" data-tooltip-text="Color Legend"><i class="fas fa-palette"></i></button>
      <button id="templateBtn" data-tooltip-text="Load a Template" style="display: none;"><i class="fas fa-file-alt"></i></button>
      <button id="projectDescBtn" data-tooltip-text="Project Description"><i class="fas fa-info-circle"></i></button>
      <button id="addConnectorBtn" data-tooltip-text="Add Connector"><i class="fas fa-link"></i></button>
      <button id="saveBtn" data-tooltip-text="Save Flowchart (Demo Mode)"><i class="fas fa-floppy-disk"></i></button>
      <button id="shareBtn" data-tooltip-text="Share"><i class="fas fa-share-alt"></i></button>
      <input type="file" id="fileInput" accept=".json" style="display: none;" />
      <button id="uploadBtn" data-tooltip-text="Upload Flowchart" style="display: none;"><i class="fas fa-upload"></i></button>
      <div id="fileNameDisplay">Demo: Project Phoenix</div>
      <button id="themeToggleBtn" data-tooltip-text="Toggle Theme"><i class="fas fa-moon"></i></button>
    </nav>
  </header>
  
  <div id="color-legend-display"></div>

  <div id="flowchartContainer">
    <svg id="flowchart">
      <defs>
        <polygon id="central-arrow-shape" points="0,-20 40,0 0,20" /> 
      </defs>
    </svg>
    <div id="banner-container"><iframe src="https://view.genially.com/6851f73b42060080e8ea8922" allowtransparency="true" scrolling="no" frameborder="0"></iframe></div>
  </div>

  <div id="modal" class="modal"><div class="modal-content"><span class="close-button" id="closeModal">×</span><h2>Task Details</h2><form id="taskForm"><label>Task Name: <textarea id="taskName" required></textarea></label><label>Responsible: <input type="text" id="responsible" /></label><label>Status:<select id="status"><option value="Not Started">Not Started</option><option value="In Progress">In Progress</option><option value="Completed">Completed</option></select></label><label>Deadline: <input type="date" id="deadline" /></label><label>Priority:<select id="priority"><option value="Low">Low</option><option value="Normal">Normal</option><option value="High">High</option></select></label>
  <label>Action Description (Sub-tasks):</label>
  <table id="taskTable"><thead><tr><th style="width: 30px;">✓</th><th>Tasks</th></tr></thead><tbody></tbody></table><button type="button" id="addTaskRowBtn" class="modal-btn">Add Task</button>
  <label>Node Color:</label>
  <input type="hidden" id="nodeColor" />
  <div class="color-panel">
      <div class="color-swatch" data-color="#e74c3c"></div>
      <div class="color-swatch" data-color="#f1c40f"></div>
      <div class="color-swatch" data-color="#2ecc71"></div>
      <div class="color-swatch" data-color="#3498db"></div>
      <div class="color-swatch" data-color="#9b59b6"></div>
      <div class="color-swatch" data-color="#34495e"></div>
  </div>
  <div class="action-buttons"><button type="submit" class="modal-btn">Save Node</button><button type="button" class="modal-btn" id="addNodeBtn">Add Child Node</button></div><div style="text-align: center; margin-top: 20px;"><button type="button" id="deleteNodeBtn" class="modal-btn danger">Delete Node</button></div></form></div></div>
  
  <div id="demoSaveModal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="closeDemoSaveModal">×</span>
      <h2>🚫 Demo Version - Save Not Available</h2>
      <p>As a Demo, this version cannot save or export flowcharts.</p>
      <p><strong>To purchase the full FlowChart Manager template with saving capabilities:</strong></p>
      <div style="text-align: center; margin: 2rem 0;">
        <a href="https://www.socialeap.net/shop-flowchart" target="_blank" class="modal-btn primary">
          Visit Our Product Page
        </a>
      </div>
    </div>
  </div>
  
  <div id="templateModal" class="modal"><div class="modal-content"><span class="close-button" id="closeTemplateModal">×</span><h2>Select Template</h2><div style="display: flex; flex-direction: column; gap: 1rem;"><button class="modal-btn" data-template="prototype">Prototype Development</button><button class="modal-btn" data-template="vendor">Vendor Outreach</button><button class="modal-btn" data-template="marketing">Marketing Campaign</button></div></div></div>
  <div id="taskTextPopup" class="modal"><div class="modal-content"><span class="close-button" id="closeTaskPopup">×</span><p id="taskFullText" style="white-space: pre-wrap; max-height: 60vh; overflow-y: auto;"></p><button id="deleteTaskBtn" class="modal-btn danger">Delete Task</button></div></div>
  <div id="userGuideModal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="closeUserGuideModal">×</span>
      <h2>📘 FlowChart Manager – User Guide</h2>
      <p>For a full guide and demo, try our <a href="https://www.socialeap.net/flowchart-manager-demo" target="_blank">Interactive Tutorial</a>.</p>
      <h3>🛠️ Interface Controls</h3>
      <ul>
        <li><b>↥ Upload</b> – Import a FlowChart (json) file to continue work or load a new chart.</li>
        <li><b>💾 Save</b> – Saving a FlowChart will always create a new file version each time.</li>
        <li><b>📄 Templates</b> – Start with a ready-made template 📄 (Prototype, Vendor, or Marketing).</li>
        <li><b>🎨 Color Legend</b> – Define what each color represents in your flowchart. The legend will appear below the header.</li>
        <li><b>+/- Node Size </b> – Resize task nodes for better visibility.</li>
        <li><b>🔗 Add Connector</b> - Click to enter 'Connector Mode,' then click two nodes to link them.</li>
        <li><b>⛓️‍💥 Delete a Connector</b> - Click directly on a connector line to bring up a confirmation to delete it.</li>
        <li>ℹ︎ Use your mouse to drag entire Canvas.</li>
        <li>Use mouse wheel to further enlarge/shrink nodes.</li>
        <li><b>Share</b> – Tell your friends/colleagues about FlowChart!.</li>
      </ul>
      <h3>🧩 Working with Tasks</h3>
      <ul>
        <li>Click any node to view or edit its details.</li>
        <li>To view full sub-task details, including clickable links, click the <i class="fas fa-eye"></i> icon next to the task.</li>
        <li>To delete a specific sub-task, use the "Delete Task" button after viewing it in the popup.</li>
        <li>Completing fields like Responsible, Deadline, and Priority helps align your workflow, track progress, and maintain clarity.</li>
      </ul>
       <h3><i class="fas fa-lightbulb"></i> GPT FlowChart Assistant</h3>
        <ul>
            <li>When initiating the💡AI Assistant, ensure that you deactivate 'Full Screen' mode of your browser so that the Assistant will overlap.</li>
            <li>Click the 💡 button to open our FlowChart AI Assistant. </li>
            <li>Ask the AI assistant to:
                <ul style="margin-top: 0.5em;">
                    <li>Analyze and suggest improvements</li>
                    <li>Provide insights, summaries, reports</li>
                    <li>Update/Add/Delete node titles, deadlines, tasks, etc.</li>
                </ul>
            </li>
        </ul>
<!-- Feedback Button Start -->
<div style="text-align: center; margin-top: 2rem;">
    <a href="https://form.jotform.com/Transcendence_Media/flowchart-feedback-form" target="_blank" class="modal-btn" style="text-decoration: none; display: inline-block;">
        <i class="fas fa-comment-alt"></i> Share Your Feedback
    </a>
</div>
<!-- Feedback Button End -->
    </div>
  </div>
  <div id="connectorOptionsModal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="closeConnectorOptionsModal">×</span>
        <h2>Connector Options</h2>
        <form id="connectorOptionsForm">
            <label>Line Style:</label>
            <div class="style-options">
                <button type="button" class="modal-btn line-style-btn" data-style="solid"><i class="fas fa-minus"></i> Solid</button>
                <button type="button" class="modal-btn line-style-btn" data-style="dotted"><i class="fas fa-dot-circle"></i> Dotted</button>
            </div>

            <label>Arrow:</label>
            <div class="arrow-controls-group">
                <button type="button" class="modal-btn arrow-control-btn" id="addRemoveArrowBtn"><i class="fas fa-plus-circle" id="addRemoveArrowIcon"></i> <span id="addRemoveArrowText">Add Arrow</span></button>
                <button type="button" class="modal-btn arrow-control-btn" id="switchArrowDirectionBtn"><i class="fas fa-arrows-alt-h"></i> Switch Direction</button>
            </div>
            
            <div class="link-options-action-buttons">
                <button type="submit" class="modal-btn" id="saveConnectorOptionsBtn">Save Options</button>
                <button type="button" id="confirmDeleteLinkBtn" class="modal-btn danger">Delete Connector</button>
            </div>
        </form>
    </div>
  </div>
  <div id="shareModal" class="modal"><div class="modal-content"><span class="close-button" id="closeShareModal">×</span><h2>Share Flowchart</h2><iframe src="https://view.genially.com/6845a98ee4504c754b83f421" allowfullscreen="true" scrolling="no" frameborder="0"></iframe></div></div>
  <div id="projectDescModal" class="modal"><div class="modal-content"><span class="close-button" id="closeProjectDescModal">×</span><h2>Project Description</h2><p id="projectSummary"></p><p id="projectGeneratedDate"></p></div></div>
  <div id="colorLegendModal" class="modal"><div class="modal-content"><span class="close-button" id="closeColorLegendModal">×</span><h2>Edit Color Legend</h2><form id="colorLegendForm"><p>Define what each color represents. These will be shown in a legend below the header.</p><div id="color-legend-entries"></div><div class="action-buttons"><button type="submit" class="modal-btn">Save Legend</button></div></form></div></div>
  <div id="tooltip"></div>

  <script>
    const DEMO_DATA = { "flowchartName": "Project Phoenix: Product Launch", "projectDescription": { "summary": "This template outlines a comprehensive project for launching a new product, segmenting it into key phases and detailing the essential tasks within each phase. It's designed to help teams visualize the entire product lifecycle from conceptualization to post-launch review, ensuring critical dependencies are identified and responsibilities are clear. The template uses different colors to distinguish between high-level phases, detailed tasks, and milestones.", "generatedDate": "2025-06-16 09:09:41 PM EDT" }, "nodes": [{ "id": "phase-1-initiation", "name": "Phase 1: Project Initiation", "status": "Completed", "responsible": "Project Lead", "deadline": "2025-01-15", "priority": "High", "actionDescription": "[{\"completed\":true,\"task\":\"Define project scope and objectives\"},{\"completed\":true,\"task\":\"Assemble core project team\"}]", "color": "#3498db", "x": 879.5, "y": 219.6 }, { "id": "task-1-1-kickoff", "name": "Task: Conduct Project Kick-off Meeting", "status": "Completed", "responsible": "Project Lead", "deadline": "2025-01-10", "priority": "High", "actionDescription": "[{\"completed\":true,\"task\":\"Set initial agenda\"},{\"completed\":true,\"task\":\"Invite stakeholders\"},{\"completed\":true,\"task\":\"Distribute project brief\"}]", "color": "#2ecc71", "x": 694.8, "y": 572.0 }, { "id": "task-1-2-req", "name": "Task: Gather Initial Requirements", "status": "Completed", "responsible": "Product Team", "deadline": "2025-01-15", "priority": "High", "actionDescription": "[{\"completed\":true,\"task\":\"Interview key users\"},{\"completed\":true,\"task\":\"Document functional requirements\"}]", "color": "#2ecc71", "x": 906.9, "y": 574.9 }, { "id": "milestone-1-scope", "name": "Milestone: Scope Approved Milestone", "status": "Completed", "responsible": "Steering Committee", "deadline": "2025-01-20", "priority": "High", "actionDescription": "[{\"completed\":true,\"task\":\"Formal scope sign-off\"}]", "color": "#9b59b6", "x": 909.2, "y": 1032.7 }, { "id": "phase-2-planning", "name": "Phase 2: Planning & Design", "status": "In Progress", "responsible": "Project Team", "deadline": "2025-03-01", "priority": "High", "actionDescription": "[{\"completed\":false,\"task\":\"Develop detailed project plan\"},{\"completed\":false,\"task\":\"Create UX/UI designs\"}]", "color": "#3498db", "x": 1206.5, "y": 222.1 }, { "id": "task-2-1-plan", "name": "Task: Develop Detailed Project Plan", "status": "In Progress", "responsible": "Project Lead", "deadline": "2025-02-10", "priority": "High", "actionDescription": "[{\"completed\":false,\"task\":\"Breakdown tasks into sprints\"},{\"completed\":false,\"task\":\"Allocate resources\"},{\"completed\":false,\"task\":\"Define timelines\"}]", "color": "#f1c40f", "x": 1175.6, "y": 580.3 }, { "id": "task-2-2-design", "name": "Task: Create UX/UI Designs", "status": "In Progress", "responsible": "Design Team", "deadline": "2025-02-28", "priority": "Normal", "actionDescription": "[{\"completed\":false,\"task\":\"Wireframe user flows\"},{\"completed\":false,\"task\":\"Design mockups\"},{\"completed\":false,\"task\":\"Conduct usability testing\"}]", "color": "#f1c40f", "x": 1368.5, "y": 583.7 }, { "id": "milestone-2-design", "name": "Milestone: Design Approved Milestone", "status": "Not Started", "responsible": "Product Owner", "deadline": "2025-03-05", "priority": "High", "actionDescription": "[{\"completed\":false,\"task\":\"Review and approve final designs\"}]", "color": "#9b59b6", "x": 1349.9, "y": 1027.2 }, { "id": "phase-3-dev", "name": "Phase 3: Development & QA", "status": "Not Started", "responsible": "Engineering Lead", "deadline": "2025-05-15", "priority": "High", "actionDescription": "[{\"completed\":false,\"task\":\"Develop core features\"},{\"completed\":false,\"task\":\"Perform rigorous testing\"}]", "color": "#3498db", "x": 1687.9, "y": 222.1 }, { "id": "task-3-1-backend", "name": "Task: Backend Development", "status": "Not Started", "responsible": "Backend Team", "deadline": "2025-04-30", "priority": "High", "actionDescription": "[{\"completed\":false,\"task\":\"Set up APIs\"},{\"completed\":false,\"task\":\"Database integration\"},{\"completed\":false,\"task\":\"Server-side logic\"}]", "color": "#e74c3c", "x": 1627.4, "y": 582.8 }, { "id": "task-3-2-frontend", "name": "Task: Frontend Development", "status": "Not Started", "responsible": "Frontend Team", "deadline": "2025-05-10", "priority": "Normal", "actionDescription": "[{\"completed\":false,\"task\":\"Build user interface\"},{\"completed\":false,\"task\":\"Integrate with backend APIs\"}]", "color": "#e74c3c", "x": 1848.0, "y": 578.5 }, { "id": "task-3-3-qa", "name": "Task: Quality Assurance Testing", "status": "Not Started", "responsible": "QA Team", "deadline": "2025-05-15", "priority": "High", "actionDescription": "[{\"completed\":false,\"task\":\"Develop test cases\"},{\"completed\":false,\"task\":\"Execute unit tests\"},{\"completed\":false,\"task\":\"Perform integration tests\"},{\"completed\":false,\"task\":\"Conduct UAT with stakeholders\"}]", "color": "#e74c3c", "x": 1742.5, "y": 793.7 }, { "id": "milestone-3-devcomplete", "name": "Milestone: Development Complete Milestone", "status": "Not Started", "responsible": "Engineering Lead", "deadline": "2025-05-20", "priority": "High", "actionDescription": "[{\"completed\":false,\"task\":\"All features developed and tested\"}]", "color": "#9b59b6", "x": 1901.0, "y": 1024.5 }, { "id": "phase-4-launch", "name": "Phase 4: Launch & Post-Launch", "status": "Not Started", "responsible": "Marketing Lead", "deadline": "2025-06-30", "priority": "High", "actionDescription": "[{\"completed\":false,\"task\":\"Execute marketing campaign\"},{\"completed\":false,\"task\":\"Monitor post-launch performance\"}]", "color": "#3498db", "x": 2125.8, "y": 217.6 }, { "id": "task-4-1-marketing", "name": "Task: Prepare & Execute Marketing Campaign", "status": "Not Started", "responsible": "Marketing Team", "deadline": "2025-06-01", "priority": "Normal", "actionDescription": "[{\"completed\":false,\"task\":\"Create launch content\"},{\"completed\":false,\"task\":\"Plan social media campaign\"},{\"completed\":false,\"task\":\"Set up advertising channels\"}]", "color": "#e74c3c", "x": 2145.2, "y": 583.5 }, { "id": "task-4-2-deployment", "name": "Task: Final Deployment", "status": "Not Started", "responsible": "DevOps", "deadline": "2025-06-10", "priority": "High", "actionDescription": "[{\"completed\":false,\"task\":\"Prepare production environment\"},{\"completed\":false,\"task\":\"Execute deployment script\"}]", "color": "#e74c3c", "x": 2401.6, "y": 583.2 }, { "id": "milestone-4-launchday", "name": "Milestone: Product Launch Day!", "status": "Not Started", "responsible": "All Teams", "deadline": "2025-06-15", "priority": "High", "actionDescription": "[{\"completed\":false,\"task\":\"Execute launch plan\"},{\"completed\":false,\"task\":\"Monitor systems closely\"}]", "color": "#9b59b6", "x": 2200.4, "y": 1025.9 }, { "id": "task-4-3-review", "name": "Task: Post-Launch Review & Iteration", "status": "Not Started", "responsible": "Project Lead", "deadline": "2025-06-30", "priority": "Normal", "actionDescription": "[{\"completed\":false,\"task\":\"Gather user feedback\"},{\"completed\":false,\"task\":\"Analyze performance metrics\"},{\"completed\":false,\"task\":\"Plan next iterations\"}]", "color": "#e74c3c", "x": 2452.9, "y": 1181.0 }], "links": [{ "source": "phase-1-initiation", "target": "task-1-1-kickoff" }, { "source": "phase-1-initiation", "target": "task-1-2-req" }, { "source": "task-1-1-kickoff", "target": "milestone-1-scope" }, { "source": "task-1-2-req", "target": "milestone-1-scope" }, { "source": "milestone-1-scope", "target": "phase-2-planning" }, { "source": "phase-2-planning", "target": "task-2-1-plan" }, { "source": "phase-2-planning", "target": "task-2-2-design" }, { "source": "task-2-1-plan", "target": "milestone-2-design" }, { "source": "task-2-2-design", "target": "milestone-2-design" }, { "source": "milestone-2-design", "target": "phase-3-dev" }, { "source": "phase-3-dev", "target": "task-3-1-backend" }, { "source": "phase-3-dev", "target": "task-3-2-frontend" }, { "source": "task-3-1-backend", "target": "task-3-3-qa" }, { "source": "task-3-2-frontend", "target": "task-3-3-qa" }, { "source": "task-3-3-qa", "target": "milestone-3-devcomplete" }, { "source": "milestone-3-devcomplete", "target": "phase-4-launch" }, { "source": "phase-4-launch", "target": "task-4-1-marketing" }, { "source": "phase-4-launch", "target": "task-4-2-deployment" }, { "source": "task-4-1-marketing", "target": "milestone-4-launchday" }, { "source": "task-4-2-deployment", "target": "milestone-4-launchday" }, { "source": "milestone-4-launchday", "target": "task-4-3-review" }], "colorLegend": { "#3498db": "Phase Nodes (High-Level Stages)", "#2ecc71": "Completed Tasks", "#f1c40f": "In-Progress Tasks", "#e74c3c": "Not Started / Critical Tasks", "#9b59b6": "Key Milestones" } };

    let selectedNode = null, selectedLink = null,
      data = JSON.parse(JSON.stringify(DEMO_DATA)),
      simulation, svg, nodeGroup, linkGroup, mainZoomGroup,
      isInitialLayout = true;
    const BASE_NODE_DIMENSION = 160;
    let currentNodeSizeFactor = 1.0;
    const MIN_NODE_SIZE_FACTOR = 0.5, MAX_NODE_SIZE_FACTOR = 1.5, NODE_SIZE_STEP = 0.1;
    let connectorMode = false, connectorStartNode = null;
    const g = (id) => document.getElementById(id);

    function hexToRgba(hex, alpha = 1) {
      if (!hex || typeof hex !== 'string') return `rgba(200,200,200,${alpha})`;
      hex = hex.replace('#', ''); let r = 0, g = 0, b = 0;
      if (hex.length === 3) { r = parseInt(hex[0] + hex[0], 16); g = parseInt(hex[1] + hex[1], 16); b = parseInt(hex[2] + hex[2], 16); } 
      else if (hex.length === 6) { r = parseInt(hex.substring(0, 2), 16); g = parseInt(hex.substring(2, 4), 16); b = parseInt(hex.substring(4, 6), 16); } 
      else { return `rgba(128, 128, 128, ${alpha})`; }
      if (isNaN(r) || isNaN(g) || isNaN(b)) return `rgba(128,128,128,${alpha})`;
      return `rgba(${r},${g},${b},${alpha})`;
    }

    // Helper function to get safe positioning coordinates within the visible area
    function getSafePositioningArea() {
        const fcCont = g('flowchartContainer');
        const containerWidth = fcCont.clientWidth;
        const containerHeight = fcCont.clientHeight;
        
        const vB = svg.attr('viewBox').split(' ');
        const viewBoxWidth = parseFloat(vB[2]);
        const viewBoxHeight = parseFloat(vB[3]);
        
        const topMarginPercent = 0.15; 
        const sideMarginPercent = 0.1; 
        const bottomMarginPercent = 0.1; 
        
        const topMargin = viewBoxHeight * topMarginPercent;
        const sideMargin = viewBoxWidth * sideMarginPercent;
        const bottomMargin = viewBoxHeight * bottomMarginPercent;
        
        return {
            left: sideMargin,
            right: viewBoxWidth - sideMargin,
            top: topMargin,
            bottom: viewBoxHeight - bottomMargin,
            centerX: viewBoxWidth / 2,
            centerY: topMargin + (viewBoxHeight - topMargin - bottomMargin) / 2,
            width: viewBoxWidth - 2 * sideMargin,
            height: viewBoxHeight - topMargin - bottomMargin
        };
    }

    function initD3() {
        const fcCont = g('flowchartContainer');
        const cW = fcCont.clientWidth, cH = fcCont.clientHeight;
        const vW = Math.max(cW * 1.5, 2000), vH = Math.max(cH * 1.5, 1500);
        
        svg = d3.select('#flowchart').attr('viewBox', `0 0 ${vW} ${vH}`);
        
        svg.html(''); 

        // Define SVG arrow shape in defs
        svg.append('defs')
            .append('polygon')
            .attr('id', 'central-arrow-shape')
            .attr('points', '0,-20 40,0 0,20'); 

        mainZoomGroup = svg.append('g').attr('class', 'zoom-group');
        linkGroup = mainZoomGroup.append('g').attr('class', 'links');
        nodeGroup = mainZoomGroup.append('g').attr('class', 'nodes');
        
        const centerX = vW / 2;
        const centerY = vH * 0.4; 
        
        simulation = d3.forceSimulation()
            .force('charge', d3.forceManyBody().strength(-1800 * (BASE_NODE_DIMENSION / 160)))
            .force('collide', d3.forceCollide().radius((BASE_NODE_DIMENSION * 0.55) + 25).strength(0.9))
            .force('center', d3.forceCenter(centerX, centerY));
            
        const zoom = d3.zoom()
            .filter(event => !event.target.closest('.node-group'))
            .on('zoom', (event) => {
                mainZoomGroup.attr('transform', event.transform);
            });
        svg.call(zoom).on("dblclick.zoom", null);
    }
    
    function ticked() {
        const currentScaledDimension = BASE_NODE_DIMENSION * currentNodeSizeFactor;
        nodeGroup.selectAll('g.node-group')
            .attr('transform', d => `translate(${d.x},${d.y})`);
        
        // MODIFIED: Update both the hit area line and the visible line
        linkGroup.selectAll('.link-container').each(function(d) {
            if (d.source && d.target) {
                const sourcePoint = getIntersectionPoint(d.source, d.target, currentScaledDimension, currentScaledDimension);
                const targetPoint = getIntersectionPoint(d.target, d.source, currentScaledDimension, currentScaledDimension);
                
                d3.select(this).selectAll('line') // Select both lines within the container
                    .attr('x1', sourcePoint.x)
                    .attr('y1', sourcePoint.y)
                    .attr('x2', targetPoint.x)
                    .attr('y2', targetPoint.y);
            }
        });

        // Update position and rotation of arrows
        mainZoomGroup.selectAll('g.link-arrow').each(function(d) {
            if (!d.source || !d.target) return; 

            const sx = d.source.x, sy = d.source.y;
            const tx = d.target.x, ty = d.target.y;

            const midX = (sx + tx) / 2;
            const midY = (sy + ty) / 2;
            const angleRad = Math.atan2(ty - sy, tx - sx);
            let angleDeg = angleRad * 180 / Math.PI;

            if (d.arrowDirection === 'backward') { 
                angleDeg += 180; 
            } 
            
            d3.select(this)
                .attr('transform', `translate(${midX},${midY}) rotate(${angleDeg})`);
        });
    }

    const drag = d3.drag()
        .on('start', function(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
            d3.select(this).classed('dragging', true);
        })
        .on('drag', function(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        })
        .on('end', function(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d3.select(this).classed('dragging', false);
        });
    
    function update() {
        if (!svg || !simulation) return;
        updateLegendDisplay();
        
        simulation.nodes(data.nodes).on("tick", ticked);

        if(data.links.length > 0) { 
            simulation.force('link', d3.forceLink(data.links).id(d => d.id).distance(250).strength(0.05));
        } else {
            simulation.force('link', null);
        }

        if (isInitialLayout) {
            const hasPositions = data.nodes.every(n => typeof n.x === 'number' && typeof n.y === 'number');
            
            if (!hasPositions) {
            } else {
                 data.nodes.forEach(d => {
                    d.fx = d.x;
                    d.fy = d.y;
                });
            }
            isInitialLayout = false;
        }

        // NEW: Create a container group for each link that will hold both the hit area and the visible line
        let linkContainer = linkGroup.selectAll('g.link-container')
            .data(data.links, d => `${d.source.id || d.source}-${d.target.id || d.target}`);

        linkContainer.exit().remove();

        let linkContainerEnter = linkContainer.enter().append('g')
            .attr('class', 'link-container');
        
        // Append the hit area line first (so it's behind the visible line visually)
        linkContainerEnter.append('line')
            .attr('class', 'link-hit-area')
            .on('click', linkClickHandler); // Attach handler to hit area

        // Append the visible line
        linkContainerEnter.append('line')
            .attr('class', 'link-visible')
            .attr('stroke', 'var(--link-color)')
            .attr('stroke-width', 2.5);

        linkContainer = linkContainerEnter.merge(linkContainer);

        // Apply selected class to the container, which CSS will use to style the visible line
        linkContainer.classed('selected', d => d === selectedLink);
        
        // Update the visible line's dash array
        linkContainer.select('line.link-visible')
            .attr('stroke-dasharray', d => d.lineStyle === 'dotted' ? '5,5' : 'none');

        // D3 selection for arrows
        // Filter explicitly for 'forward' or 'backward' for arrow display
        let arrows = mainZoomGroup.selectAll('g.link-arrow')
            .data(data.links.filter(d => d.arrowDirection === 'forward' || d.arrowDirection === 'backward'), d => d.id);

        arrows.exit().remove(); 

        let arrowsEnter = arrows.enter().append('g')
            .attr('class', 'link-arrow')
            .append('use')
            .attr('href', '#central-arrow-shape'); 

        arrows = arrowsEnter.merge(arrows); 

        // Update styling for arrows (e.g., color)
        arrows.select('use').attr('fill', 'var(--link-color)'); 

        let node = nodeGroup.selectAll('g.node-group').data(data.nodes, d => d.id);
        node.exit().remove();
        
        const nodeEnter = node.enter().append('g').attr('class', 'node-group').call(drag);
        
        nodeEnter.append('foreignObject')
            .attr('class', 'flowchart-node-html-wrapper')
            .append('xhtml:div').attr('class', 'flowchart-node-html');
        
        node = nodeEnter.merge(node);
        
        node.on('click', (event, d) => {
            if (event.defaultPrevented) return; 
            event.stopPropagation();
            if (connectorMode) {
                if (!connectorStartNode) {
                    connectorStartNode = d;
                    d3.select(event.currentTarget).select('.flowchart-node-html').style('outline', '3px solid var(--link-selected-color)');
                } else if (d.id !== connectorStartNode.id) {
                    nodeGroup.selectAll('.flowchart-node-html').style('outline', 'none');
                    const linkExists = data.links.some(l => 
                        ((l.source.id || l.source) === connectorStartNode.id && (l.target.id || l.target) === d.id) ||
                        ((l.source.id || l.source) === d.id && (l.target.id || l.target) === connectorStartNode.id)
                    );
                    if (!linkExists) {
                        data.links.push({ 
                            source: connectorStartNode.id, 
                            target: d.id,
                            lineStyle: 'solid', // Default for new links
                            arrowDirection: 'none' // Default for new links
                        });
                        update();
                    }
                    connectorMode = false;
                    connectorStartNode = null;
                    g('addConnectorBtn').classList.remove('active');
                    g('flowchart').style.cursor = 'default';
                }
            } else {
                nodeClick(event, d);
            }
        });

        const currentScaledDimension = BASE_NODE_DIMENSION * currentNodeSizeFactor;
        node.select('foreignObject')
            .attr('width', currentScaledDimension).attr('height', currentScaledDimension)
            .attr('x', -currentScaledDimension / 2).attr('y', -currentScaledDimension / 2);

        node.select('.flowchart-node-html').each(function(d) {
            const nodeOuterDiv = d3.select(this);
            const nodeFillOpacity = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--node-fill-opacity').trim() || '0.7');
            const baseColorHex = d.color ? d.color : getStatusColor(d.status);
            nodeOuterDiv.style('background-color', hexToRgba(baseColorHex, nodeFillOpacity));
            
            let pillDiv = nodeOuterDiv.select('.task-count-pill-html');
            if (pillDiv.empty()) pillDiv = nodeOuterDiv.append('div').attr('class', 'task-count-pill-html');
            let nameDiv = nodeOuterDiv.select('.node-name-html');
            if (nameDiv.empty()) nameDiv = nodeOuterDiv.append('div').attr('class', 'node-name-html');
            let prDiv = nodeOuterDiv.select('.priority-indicator');
            if (prDiv.empty()) prDiv = nodeOuterDiv.append('div').attr('class', 'priority-indicator');
            
            nameDiv.text(d.name || '');
            let indicatorHtml = d.priority === 'Low' ? '🔴 ⚪️ ⚪️' : d.priority === 'Normal' ? '🔴 🔴 ⚪️' : d.priority === 'High' ? '🔴 🔴 🔴' : '⚪️ ⚪️ ⚪️';
            prDiv.html(indicatorHtml);
            let tasks = []; try { if (d.actionDescription) tasks = JSON.parse(d.actionDescription); } catch (e) {}
            const compC = tasks.filter((t) => t.completed).length, totC = tasks.length;
            if (totC > 0) { pillDiv.text(`✓ ${compC}/${totC}`).style('display', 'block'); } 
            else { pillDiv.style('display', 'none'); }
        });
        
        simulation.alpha(0.3).restart();
    }

    function getIntersectionPoint(sourceNode, targetNode, width, height) {
        const sx = sourceNode.x, sy = sourceNode.y;
        const tx = targetNode.x, ty = targetNode.y;
        
        const dx = tx - sx;
        const dy = ty - sy;

        if (dx === 0 && dy === 0) {
            return { x: sx, y: sy };
        }

        const angle = Math.atan2(dy, dx);
        const halfWidth = width / 2;
        const halfHeight = height / 2;

        const cornerAngle = Math.atan2(halfHeight, halfWidth);

        let ix, iy;
        if (angle > -cornerAngle && angle <= cornerAngle) {
            ix = sx + halfWidth;
            iy = sy + halfWidth * Math.tan(angle);
        } else if (angle > cornerAngle && angle <= Math.PI - cornerAngle) {
            ix = sx + halfHeight / Math.tan(angle);
            iy = sy + halfHeight;
        } else if (angle > Math.PI - cornerAngle || angle <= -(Math.PI - cornerAngle)) {
            ix = sx - halfWidth;
            iy = sy - halfWidth * Math.tan(angle);
        } else {
            ix = sx - halfHeight / Math.tan(angle);
            iy = sy - halfHeight;
        }

        return { x: ix, y: iy };
    }

    function getStatusColor(s) {
      switch (s) { case 'Not Started': return '#e74c3c'; case 'In Progress': return '#f1c40f'; case 'Completed': return '#2ecc71'; default: return '#3498db'; }
    }
    
    function openAIAssistant() { const url = 'https://chatgpt.com/g/g-685378a9eac48191b34ec9d5be8d6734-flow-chart-demo-assistant'; const sW = window.screen.availWidth, sH = window.screen.availHeight, bS = Math.min(sW, sH); const pW = Math.floor(bS * 0.45), pH = Math.floor(bS * 0.55), l = Math.floor((sW - pW) / 2), t = Math.floor((sH - pH) / 2); window.open(url, 'FlowchartAIAssistant', `width=${pW},height=${pH},left=${l},top=${t},resizable=yes,scrollbars=yes`); }
    
    function addTaskRow(t) {
        const tb = g('taskTable').querySelector('tbody');
        const tr = document.createElement('tr');
        
        tr.addEventListener('click', function () {
            document.querySelectorAll('#taskTable tbody tr').forEach((r) => r.classList.remove('selectedTaskRow'));
            this.classList.add('selectedTaskRow');
        });

        const tdC = document.createElement('td');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = t && t.completed;
        tdC.appendChild(cb);

        const tdT = document.createElement('td'); 
        tdT.classList.add('task-cell-content'); 
        
        const ti = document.createElement('textarea');
        ti.classList.add('task-detail-textarea');
        ti.value = t && t.task ? t.task : '';
        ti.rows = 1;
        ti.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        
        const viewIcon = document.createElement('i');
        viewIcon.classList.add('fas', 'fa-eye', 'task-view-icon');
        viewIcon.setAttribute('title', 'View full task details and links'); 
        
        viewIcon.addEventListener('click', function(e) {
            e.stopPropagation(); 
            tr.classList.add('selectedTaskRow'); 
            
            console.log('Eye icon clicked!');
            console.log('Attempting to show popup with text:', ti.value);

            showTaskPopup(ti.value); 
        });

        tdT.appendChild(ti);
        tdT.appendChild(viewIcon);

        tr.appendChild(tdC);
        tr.appendChild(tdT); 
        tb.appendChild(tr);
        ti.dispatchEvent(new Event('input')); 
    }

    function populateTaskTable(str) { const tb = g('taskTable').querySelector('tbody'); tb.innerHTML = ''; let arr = []; try { arr = JSON.parse(str); if (!Array.isArray(arr)) arr = str.trim() ? [{ completed: false, task: str }] : []; } catch (e) { arr = str.trim() ? [{ completed: false, task: str }] : []; } if (Array.isArray(str)) arr = str; if (arr.length > 0) arr.forEach((t) => addTaskRow(t)); else addTaskRow({}); }
    
    function showTaskPopup(txt) {
        console.log('showTaskPopup called with:', txt);

        const linkedHtml = linkifyHtml(txt, {
            target: '_blank',           
            rel: 'noopener noreferrer'  
        });

        const taskFullTextElement = g('taskFullText');
        const taskTextPopupModal = g('taskTextPopup');

        if (taskFullTextElement && taskTextPopupModal) {
            taskFullTextElement.innerHTML = linkedHtml; 
            taskTextPopupModal.style.display = 'block'; 
            console.log('taskTextPopup and taskFullText elements found. Modal display set to block.');
        } else {
            console.error('Error: Could not find taskFullText or taskTextPopup elements. Please check your HTML IDs.');
        }
    }
    
    function updateProjectDescButton() { const hasDesc = data.projectDescription && data.projectDescription.summary.trim().length > 0; g('projectDescBtn').style.display = hasDesc ? 'inline-flex' : 'none'; }
    function nodeClick(ev, d) { ev.stopPropagation(); selectedNode = d; g('taskName').value = d.name || ''; g('responsible').value = d.responsible || ''; g('status').value = d.status || 'Not Started'; g('deadline').value = d.deadline || ''; g('priority').value = d.priority || 'Normal'; populateTaskTable(d.actionDescription || ''); g('nodeColor').value = d.color || ''; document.querySelectorAll('.color-panel .color-swatch').forEach((s) => s.classList.remove('selected-swatch')); if (d.color) { const sS = document.querySelector(`.color-swatch[data-color='${d.color}']`); if (sS) sS.classList.add('selected-swatch'); } g('modal').style.display = 'block'; }
    
    function demoSaveToFile() { 
        g('demoSaveModal').style.display = 'block'; 
    }
    
    function loadFromFile(f) { 
        if (!f) { alert('No file selected.'); return; }
        const r = new FileReader();
        r.onload = (e) => {
            try {
                const fD = JSON.parse(e.target.result);
                if (fD && typeof fD === 'object' && Array.isArray(fD.nodes)) {
                    data = fD;
                    g('flowchartNameInput').value = data.flowchartName || 'Untitled';
                    updateProjectDescButton();
                    g('fileNameDisplay').innerText = `Loaded: ${f.name}`;
                    isInitialLayout = true;
                    data.nodes.forEach(d => {
                      d.fx = d.x;
                      d.fy = d.y;
                    });
                    // Ensure lineStyle and arrowDirection are set for loaded links
                    data.links.forEach(l => {
                        l.lineStyle = l.lineStyle || 'solid';
                        l.arrowDirection = l.arrowDirection || 'none';
                    });
                    update();
                } else {
                    alert('Invalid file format.');
                }
            } catch (err) {
                alert('Error parsing file.');
                console.error('Load file error:', err);
            }
        };
        r.onerror = () => alert('Error reading file.');
        r.readAsText(f);
    }
    
    function loadTemplate(tmpl) { 
        data.flowchartName = tmpl.charAt(0).toUpperCase() + tmpl.slice(1) + ' Template'; 
        g('flowchartNameInput').value = data.flowchartName; 
        data.links = []; 
        data.projectDescription = { summary: '', generatedDate: '' }; 
        data.colorLegend = {}; 
        updateProjectDescButton(); 
        
        const vB = svg.attr('viewBox').split(' ');
        const vW = parseFloat(vB[2]);
        const vH = parseFloat(vB[3]);
        
        const centerX = vW / 2;
        const centerY = vH * 0.4;
        const nodeSpacing = BASE_NODE_DIMENSION * 1.4; 
        
        switch (tmpl) { 
            case 'prototype': 
                data.nodes = [
                    { 
                        id: '1', 
                        name: 'Design System Setup', 
                        status: 'Completed', 
                        color: '#2ecc71',
                        x: centerX - nodeSpacing,
                        y: centerY
                    }, 
                    { 
                        id: '2', 
                        name: 'User Auth Development', 
                        status: 'In Progress', 
                        color: '#f1c40f',
                        x: centerX,
                        y: centerY
                    }, 
                    { 
                        id: '3', 
                        name: 'Real-time Collab Testing', 
                        status: 'Not Started', 
                        color: '#e74c3c',
                        x: centerX + nodeSpacing,
                        y: centerY
                    }
                ]; 
                break; 
            case 'vendor': 
                data.nodes = [
                    { 
                        id: '1', 
                        name: 'Identify Vendors', 
                        status: 'Completed', 
                        color: '#2ecc71',
                        x: centerX - nodeSpacing,
                        y: centerY
                    }, 
                    { 
                        id: '2', 
                        name: 'Conduct Outreach', 
                        status: 'In Progress', 
                        color: '#f1c40f',
                        x: centerX,
                        y: centerY
                    }, 
                    { 
                        id: '3', 
                        name: 'Select Final Vendor', 
                        status: 'Not Started', 
                        color: '#e74c3c',
                        x: centerX + nodeSpacing,
                        y: centerY
                    }
                ]; 
                break; 
            case 'marketing': 
                data.nodes = [
                    { 
                        id: '1', 
                        name: 'Market Research', 
                        status: 'Completed', 
                        color: '#2ecc71',
                        x: centerX,
                        y: centerY - nodeSpacing / 2 
                    }, 
                    { 
                        id: '2', 
                        name: 'Develop Strategy', 
                        status: 'In Progress', 
                        color: '#f1c40f',
                        x: centerX - nodeSpacing / 2, 
                        y: centerY + nodeSpacing / 2
                    }, 
                    { 
                        id: '3', 
                        name: 'Launch Campaign', 
                        status: 'Not Started', 
                        color: '#e74c3c',
                        x: centerX + nodeSpacing / 2, 
                        y: centerY + nodeSpacing / 2
                    }
                ]; 
                break; 
            default: 
                data.nodes = [
                    { 
                        id: 'root-1', 
                        name: 'Start New Project', 
                        status: 'Not Started', 
                        color: '#3498db', 
                        x: centerX, 
                        y: centerY
                    }
                ]; 
                data.flowchartName = 'New Flowchart'; 
                g('flowchartNameInput').value = data.flowchartName; 
        } 
        
        data.nodes.forEach(n => { 
            n.actionDescription = '[]'; 
            n.responsible = n.responsible || '';
            n.deadline = n.deadline || '';
            n.priority = n.priority || 'Normal';
            n.fx = n.x; 
            n.fy = n.y; 
        }); 
        
        isInitialLayout = true; 
        update(); 
    }

    function linkClickHandler(event, d) { 
        event.stopPropagation(); 
        selectedLink = d; 
        linkGroup.selectAll('g.link-container').classed('selected', false); 
        d3.select(this.parentNode).classed('selected', true); 

        openConnectorOptionsModal(d); 
    }

    function openConnectorOptionsModal(linkData) {
        document.querySelectorAll('#connectorOptionsModal .line-style-btn').forEach(btn => {
            if (btn.dataset.style === (linkData.lineStyle || 'solid')) { 
                btn.classList.add('selected');
            } else {
                btn.classList.remove('selected');
            }
        });

        updateConnectorModalArrowButtons();
        
        g('connectorOptionsModal').style.display = 'block';
    }

    function updateButtonSelection(clickedButton, selector) {
        document.querySelectorAll(selector).forEach(btn => {
            btn.classList.remove('selected');
        });
        clickedButton.classList.add('selected');
    }

    // MODIFIED: updateConnectorModalArrowButtons to change text and icon
    function updateConnectorModalArrowButtons() {
        const addRemoveArrowBtn = g('addRemoveArrowBtn');
        const addRemoveArrowIcon = g('addRemoveArrowIcon');
        const addRemoveArrowText = g('addRemoveArrowText');
        const switchArrowDirectionBtn = g('switchArrowDirectionBtn');

        if (selectedLink.arrowDirection === 'none') {
            addRemoveArrowBtn.classList.remove('selected');
            addRemoveArrowIcon.className = 'fas fa-plus-circle';
            addRemoveArrowText.textContent = 'Add Arrow';
            switchArrowDirectionBtn.classList.add('disabled');
        } else {
            addRemoveArrowBtn.classList.add('selected');
            addRemoveArrowIcon.className = 'fas fa-minus-circle';
            addRemoveArrowText.textContent = 'Remove Arrow';
            switchArrowDirectionBtn.classList.remove('disabled');
        }
    }

    function openColorLegendModal() { const container = g('color-legend-entries'); container.innerHTML = ''; const uniqueColors = [...new Set(data.nodes.map(n => n.color).filter(c => c))]; const opacity = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--node-fill-opacity').trim() || '0.55'); uniqueColors.forEach(color => { const entry = document.createElement('div'); entry.className = 'legend-entry'; const swatch = document.createElement('div'); swatch.className = 'legend-color-swatch'; swatch.style.backgroundColor = hexToRgba(color, opacity); const input = document.createElement('input'); input.type = 'text'; input.placeholder = `Description for ${color}`; input.dataset.color = color; input.value = data.colorLegend[color] || ''; entry.appendChild(swatch); entry.appendChild(input); container.appendChild(entry); }); g('colorLegendModal').style.display = 'block'; }
    function saveColorLegend(event) { event.preventDefault(); document.querySelectorAll('#color-legend-entries input').forEach(input => { const color = input.dataset.color, desc = input.value.trim(); if (desc) data.colorLegend[color] = desc; else delete data.colorLegend[color]; }); g('colorLegendModal').style.display = 'none'; updateLegendDisplay(); }
    function updateLegendDisplay() { const container = g('color-legend-display'); container.innerHTML = ''; const items = Object.entries(data.colorLegend); const opacity = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--node-fill-opacity').trim() || '0.55'); if (items.length > 0) { items.forEach(([color, description]) => { const item = document.createElement('div'); item.className = 'legend-display-item'; const swatch = document.createElement('div'); swatch.className = 'legend-display-color'; swatch.style.backgroundColor = hexToRgba(color, opacity); const text = document.createElement('span'); text.textContent = description; item.appendChild(swatch); item.appendChild(text); container.appendChild(item); }); container.classList.add('visible'); } else { container.classList.remove('visible'); } }
    function createNode(pN) { 
        const nId = `node-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
        const cSD = BASE_NODE_DIMENSION * currentNodeSizeFactor;
        let iX, iY;

        if (pN && typeof pN.x === 'number' && typeof pN.y === 'number') {
            iX = pN.x + (Math.random() * 100 - 50);
            iY = pN.y + cSD * 1.2; 
        } else {
            const safeArea = getSafePositioningArea();
            iX = safeArea.centerX + (Math.random() * 200 - 100);
            iY = safeArea.centerY + (Math.random() * 100 - 50);
        }

        const safeArea = getSafePositioningArea();
        iX = Math.max(safeArea.left + cSD / 2, Math.min(iX, safeArea.right - cSD / 2));
        iY = Math.max(safeArea.top + cSD / 2, Math.min(iY, safeArea.bottom - cSD / 2));

        const nN = { 
            id: nId, 
            name: 'New Task Node', 
            status: 'Not Started', 
            responsible: '', 
            deadline: '', 
            priority: 'Normal', 
            actionDescription: '[]', 
            color: null, 
            x: iX, 
            y: iY, 
            fx: iX, 
            fy: iY 
        };
        
        data.nodes.push(nN); 
        isInitialLayout = false; 
        update(); 
        return nN; 
    }
    function updateNodeSizes() { if (!simulation) return; const sD = BASE_NODE_DIMENSION * currentNodeSizeFactor; simulation.force('collide').radius((sD * 0.55) + 25); simulation.force('charge').strength(-1800 * (sD / 160)); isInitialLayout = false; update(); }
    
    document.addEventListener('DOMContentLoaded', () => {
        const fcCont = g('flowchartContainer');
        const observer = new ResizeObserver(entries => {
            const entry = entries[0];
            if (entry.contentRect.width > 0) {
                initializeApp();
                observer.disconnect();
            }
        });
        observer.observe(fcCont);
    });

    function initializeApp() {
        initD3();
        
        g('flowchartNameInput').value = data.flowchartName;
        updateProjectDescButton();
        
        const tooltip = g('tooltip');
        if (tooltip) { document.querySelectorAll('nav button[data-tooltip-text]').forEach(button => { button.addEventListener('mouseenter', () => { tooltip.textContent = button.dataset.tooltipText; const rect = button.getBoundingClientRect(); tooltip.style.top = `${rect.bottom + 8}px`; tooltip.style.left = `${rect.left + rect.width / 2}px`; tooltip.classList.add('visible'); }); button.addEventListener('mouseleave', () => tooltip.classList.remove('visible')); }); }
        
        document.querySelectorAll('.color-panel .color-swatch').forEach(swatch => { 
            const color = swatch.dataset.color;
            const opacity = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--node-fill-opacity').trim() || '0.55');
            if (color) {
                swatch.style.backgroundColor = hexToRgba(color, opacity);
            } else {
                console.warn('Color swatch missing data-color attribute:', swatch); 
            }
        });

        document.querySelectorAll('.color-panel .color-swatch').forEach(swatch => {
            swatch.addEventListener('click', function() {
                document.querySelectorAll('.color-panel .color-swatch').forEach(s => s.classList.remove('selected-swatch'));
                this.classList.add('selected-swatch');
                g('nodeColor').value = this.dataset.color;
            });
        });

        const themeToggleBtn = g('themeToggleBtn'), body = document.body, prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
        function applyTheme(theme) { body.classList.toggle('dark-mode', theme === 'dark'); themeToggleBtn.querySelector('i').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; }
        const savedTheme = localStorage.getItem('theme') || (prefersDark.matches ? 'dark' : 'light');
        applyTheme(savedTheme);
        themeToggleBtn.addEventListener('click', () => { const newTheme = body.classList.contains('dark-mode') ? 'light' : 'dark'; applyTheme(newTheme); localStorage.setItem('theme', newTheme); });
        g('aiAssistantBtn').onclick = openAIAssistant;
        g('nodeSizeIncreaseBtn').onclick = () => { if (currentNodeSizeFactor < MAX_NODE_SIZE_FACTOR) { currentNodeSizeFactor = parseFloat((currentNodeSizeFactor + NODE_SIZE_STEP).toFixed(2)); isInitialLayout = false; updateNodeSizes(); } };
        g('nodeSizeDecreaseBtn').onclick = () => { if (currentNodeSizeFactor > MIN_NODE_SIZE_FACTOR) { currentNodeSizeFactor = parseFloat((currentNodeSizeFactor - NODE_SIZE_STEP).toFixed(2)); isInitialLayout = false; updateNodeSizes(); } };
        g('colorLegendBtn').onclick = openColorLegendModal;
        g('closeColorLegendModal').onclick = () => g('colorLegendModal').style.display = 'none';
        g('colorLegendForm').onsubmit = saveColorLegend;
        g('templateBtn').onclick = () => { g('templateModal').style.display = 'block'; };
        document.querySelectorAll('#templateModal .modal-btn').forEach((b) => (b.onclick = (e) => { loadTemplate(e.target.dataset.template); g('templateModal').style.display = 'none'; }));
        const addConnBtn = g('addConnectorBtn');
        addConnBtn.addEventListener('click', () => { 
            connectorMode = !connectorMode; 
            connectorStartNode = null; 
            addConnBtn.classList.toggle('active', connectorMode); 
            g('flowchart').style.cursor = connectorMode ? 'crosshair' : 'default'; 
            if (!connectorMode) {
                nodeGroup.selectAll('.flowchart-node-html').style('outline', 'none');
            }
        });
        g('addNodeBtn').onclick = (e) => { e.preventDefault(); const nN = createNode(selectedNode); if (nN) { selectedNode = nN; nodeClick({ stopPropagation: () => {}, defaultPrevented: false }, nN); } };
        
        g('saveBtn').onclick = demoSaveToFile;
        g('closeDemoSaveModal').onclick = () => g('demoSaveModal').style.display = 'none';
        
        g('uploadBtn').onclick = () => g('fileInput').click();
        g('fileInput').onchange = (e) => { if (e.target.files.length > 0) loadFromFile(e.target.files[0]); };
        g('userGuideBtn').onclick = () => { g('userGuideModal').style.display = 'block'; };
        g('closeUserGuideModal').onclick = () => g('userGuideModal').style.display = 'none';
        g('shareBtn').onclick = () => g('shareModal').style.display = 'block';
        g('closeShareModal').onclick = () => g('shareModal').style.display = 'none';
        g('projectDescBtn').onclick = () => { const pd = data.projectDescription || {}; g('projectSummary').textContent = (pd.summary && pd.generatedDate) ? pd.summary : 'File does not contain a Project Description.'; g('projectGeneratedDate').textContent = (pd.summary && pd.generatedDate) ? `Generated: ${pd.generatedDate}` : ''; g('projectDescModal').style.display = 'block'; };
        
        // MODIFIED: Global modal close logic to exclude the new connector options modal and others
        document.querySelectorAll('.modal .close-button').forEach((b) => { 
            const modalId = b.closest('.modal').id;
            if (!['closeUserGuideModal','closeProjectDescModal','closeShareModal','closeColorLegendModal','closeDemoSaveModal', 'closeConnectorOptionsModal'].includes(b.id)) { 
                b.onclick = (e) => { 
                    e.stopPropagation(); 
                    b.closest('.modal').style.display = 'none'; 
                    if (modalId === 'modal') { 
                        selectedNode = null;
                    }
                }; 
            }
        });
        g('closeProjectDescModal').onclick = (e) => { e.stopPropagation(); g('projectDescModal').style.display = 'none'; };
        g('closeConnectorOptionsModal').onclick = (e) => { 
            e.stopPropagation(); 
            g('connectorOptionsModal').style.display = 'none';
            linkGroup.selectAll('g.link-container').classed('selected', false); 
            selectedLink = null; 
        };
        // MODIFIED: window.onclick to explicitly exclude the new connectorOptionsModal
        window.onclick = (e) => { 
            if (e.target.classList.contains('modal') && 
                !e.target.closest('#modal') && 
                !e.target.closest('#taskTextPopup') &&
                !e.target.closest('#templateModal') &&
                !e.target.closest('#userGuideModal') &&
                !e.target.closest('#shareModal') &&
                !e.target.closest('#projectDescModal') &&
                !e.target.closest('#colorLegendModal') &&
                !e.target.closest('#connectorOptionsModal') &&
                !e.target.closest('#demoSaveModal') 
            ) {
                e.target.style.display = 'none';
            }
        };

        g('taskForm').onsubmit = (e) => { e.preventDefault(); if (selectedNode) { let tsks = []; g('taskTable').querySelectorAll('tbody tr').forEach((r) => { 
            let chk = r.querySelector('input[type="checkbox"]'), 
                txt = r.querySelector('.task-detail-textarea'); 
            if (txt && txt.value.trim() !== '') tsks.push({ completed: chk.checked, task: txt.value.trim() }); 
        }); Object.assign(selectedNode, { name: g('taskName').value, responsible: g('responsible').value, status: g('status').value, deadline: g('deadline').value, priority: g('priority').value, actionDescription: JSON.stringify(tsks), color: g('nodeColor').value || null, }); selectedNode.fx = selectedNode.x; selectedNode.fy = selectedNode.y; isInitialLayout = false; update(); } g('modal').style.display = 'none'; };
        
        // MODIFIED: confirmDeleteLinkBtn to be inside the new connectorOptionsModal
        g('confirmDeleteLinkBtn').onclick = () => { 
            if (selectedLink && confirm('Are you sure you want to delete this connection?')) { 
                data.links = data.links.filter(l => l !== selectedLink); 
                isInitialLayout = false; 
                update(); 
            } 
            g('connectorOptionsModal').style.display = 'none'; 
            linkGroup.selectAll('g.link-container').classed('selected', false); 
            selectedLink = null; 
        };
        
        // New event listeners for connector options
        document.querySelectorAll('#connectorOptionsModal .line-style-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (selectedLink) {
                    selectedLink.lineStyle = this.dataset.style;
                    updateButtonSelection(this, '#connectorOptionsModal .line-style-btn');
                }
            });
        });

        g('addRemoveArrowBtn').addEventListener('click', function() {
            if (selectedLink) {
                if (selectedLink.arrowDirection === 'none') {
                    selectedLink.arrowDirection = 'forward'; // Default to 'forward' when adding
                } else {
                    selectedLink.arrowDirection = 'none'; // Toggle off if already present
                }
                updateConnectorModalArrowButtons(); // Update UI for arrow buttons
            }
        });

        g('switchArrowDirectionBtn').addEventListener('click', function() {
            if (selectedLink && selectedLink.arrowDirection !== 'none') { 
                selectedLink.arrowDirection = (selectedLink.arrowDirection === 'forward') ? 'backward' : 'forward';
                updateConnectorModalArrowButtons(); 
            }
        });

        g('saveConnectorOptionsBtn').onclick = (e) => {
            e.preventDefault(); 
            if (selectedLink) {
                update(); 
            }
            g('connectorOptionsModal').style.display = 'none'; 
            linkGroup.selectAll('g.link-container').classed('selected', false); 
            selectedLink = null;
        };


        g('addTaskRowBtn').addEventListener('click', () => addTaskRow({}));
        g('deleteTaskBtn').addEventListener('click', () => { let sR = g('taskTable').querySelector('tbody tr.selectedTaskRow'); if (sR) sR.remove(); g('taskTextPopup').style.display = 'none'; });
        g('deleteNodeBtn').addEventListener('click', () => { if (selectedNode && confirm('Delete node?')) { const selectedId = selectedNode.id; data.nodes = data.nodes.filter((n) => n.id !== selectedId); data.links = data.links.filter(l => (l.source.id || l.source) !== selectedId && (l.target.id || l.target) !== selectedId); selectedNode = null; isInitialLayout = false; update(); } g('modal').style.display = 'none'; });
        g('flowchartNameInput').addEventListener('input', function () { data.flowchartName = this.value || 'Untitled'; });
        
        // This part needs to ensure that when a new link is added, its lineStyle and arrowDirection are explicitly set
        // The original logic was in index.html in originalAddConnectorClick block, adapting it here.
        const originalAddConnectorClick = g('addConnectorBtn').onclick; 
        g('addConnectorBtn').onclick = (e) => {
            if (originalAddConnectorClick) originalAddConnectorClick(e); 

            setTimeout(() => {
                const newLink = data.links.find(l => 
                    (l.source === (connectorStartNode ? connectorStartNode.id : undefined) && l.target === (selectedNode ? selectedNode.id : undefined)) ||
                    (l.source === (selectedNode ? selectedNode.id : undefined) && l.target === (connectorStartNode ? connectorStartNode.id : undefined))
                );
                
                if (newLink && (typeof newLink.lineStyle === 'undefined' || typeof newLink.arrowDirection === 'undefined')) {
                    newLink.lineStyle = newLink.lineStyle || 'solid';
                    newLink.arrowDirection = newLink.arrowDirection || 'none'; 
                    update(); 
                }
            }, 0); 
        };

        if (data.nodes.length === 0) {
            isInitialLayout = true;
            loadTemplate('prototype');
        } else {
            isInitialLayout = true;
            update();
        }
    }
  </script>
</body>
</html>
